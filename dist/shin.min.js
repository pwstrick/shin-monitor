!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.shin=t()}(this,function(){"use strict";function e(e,t){return Math.floor(Math.random()*(e-t+1)+t)}function t(e,t){return parseFloat(e.toFixed(t))}function r(e){return t(e/1024,2)}function n(e){return e.replace(/"/g,"")}function i(){return performance.now()}function o(e){var t="";e+="";for(var r=0,n=e.length;r<n;r++){var i=e.charCodeAt(r).toString(16);t+=i.length<2?"0"+i:i}return t}function a(e){if(!e)return null;var t=y;for(var r in e){var n=e[r];if("object"==typeof n)for(var i in n)t[r][i]=n[i];else t[r]=n}var o=t.identity.getFunc;o&&o(t);var a=new u(t);a.registerErrorEvent(),a.registerUnhandledrejectionEvent(),a.registerLoadEvent(),a.recordPage(),E.reactError=a.reactError.bind(a),E.vueError=a.vueError.bind(a);var s=new g(t);s.observerLCP(),s.observerFID();var c=function(e){e.firstPaint>4e3&&(e.record=a.getRecentRecord())};s.registerLoadAndHideEvent(c);var p=new d(t);return p.injectConsole(),p.injectRouter(),p.injectEvent(),p.injectAjax(),t}var s={ACTION_ERROR:"error",ACTION_AJAX:"ajax",ACTION_EVENT:"event",ACTION_PRINT:"console",ACTION_REDIRECT:"redirect",ERROR_RUNTIME:"runtime",ERROR_SCRIPT:"script",ERROR_STYLE:"style",ERROR_IMAGE:"image",ERROR_AUDIO:"audio",ERROR_VIDEO:"video",ERROR_PROMISE:"promise",ERROR_VUE:"vue",ERROR_REACT:"react",ERROR_CRASH:"crash",LOAD_ERROR_TYPE:{SCRIPT:"script",LINK:"style",IMG:"image",AUDIO:"audio"},SHIN_MONITOR_FINGERPRINT:"shin-monitor-fingerprint",SHIN_BEHAVIOR_DATA:"shin-behavior-data"},c=function(){function r(e){this.params=e}return r.prototype.getIdentity=function(){var e="shin-monitor-identity",t=sessionStorage.getItem(e);if(!t){t=Number(Math.random().toString().substring(3,6)+Date.now()).toString(36);var r=this.params.identity.value;r&&(t=r+"-"+t),sessionStorage.setItem(e,t)}return t},r.prototype.getFingerprint=function(){var e=s.SHIN_MONITOR_FINGERPRINT,t=localStorage.getItem(e);if(t)return t;var r=document.createElement("canvas"),n=r.getContext("2d"),i="fingerprint";n.textBaseline="top",n.font="16px Arial",n.fillStyle="#F60",n.fillRect(125,1,62,20),n.fillStyle="#069",n.fillText(i,2,15),n.fillStyle="rgba(102, 204, 0, 0.7)",n.fillText(i,4,17);var a=r.toDataURL().replace("data:image/png;base64,",""),c=window.atob(a),u=o(c.slice(-16,-12));return localStorage.setItem(e,u),u},r.prototype.paramify=function(e){return e.author=this.params.author,e.token=this.params.token,e.subdir=this.params.subdir,e.identity=this.getIdentity(),e.fingerprint=this.getFingerprint(),e.referer=location.href,JSON.stringify(e)},r.prototype.send=function(e,t){var r=this.paramify(e);if(!(r.length>=8e3)){var n={m:r};t&&t(e,n),fetch(this.params.src,{method:"POST",body:JSON.stringify(n)})}},r.prototype.paramifyPerformance=function(e){e.token=this.params.token,e.pkey=this.params.pkey,e.identity=this.getIdentity(),e.referer=location.href;var r=performance.getEntriesByType("resource"),n=[],i=0;return r&&r.forEach(function(r){var o=r.name,a=r.initiatorType,s=r.startTime,c=r.duration,u=r.transferSize;"fetch"!==a&&(s>6e4||(n.push({name:o,duration:t(c),startTime:t(s),transferSize:u}),u&&s<=e.firstScreen&&(i+=u)))}),e.transferScreenSize=i,e.resource=n,JSON.stringify(e)},r.prototype.sendPerformance=function(t){var r=this.paramifyPerformance(t);if(this.rate=e(10,1),this.params.rate>=this.rate&&this.params.pkey){if(this.params.record.isSendInPerformance)return void fetch(this.params.psrc,{method:"POST",body:r});navigator.sendBeacon(this.params.psrc,r)}},r.prototype.paramifyBehavior=function(e){return e.pkey=this.params.pkey,e.identity=this.getIdentity(),e.referer=location.href,JSON.stringify(e)},r.prototype.sendBehavior=function(e){if(this.rate&&this.params.rate>=this.rate&&this.params.pkey){var t=this.paramifyBehavior(e);navigator.sendBeacon(this.params.psrc,t)}},r.prototype.sendBeacon=function(e){navigator.sendBeacon(this.params.psrc,e)},r}(),u=function(){function e(e){this.params=e,this.recordEventsMatrix=[[]],this.http=new c(e)}return e.prototype.registerErrorEvent=function(){var e=this,t=this.params.error.isFilterErrorFunc;window.addEventListener("error",function(r){var n=r.target;t&&t(r)||(n!==window&&n.nodeName&&s.LOAD_ERROR_TYPE[n.nodeName.toUpperCase()]?e.handleError(e.formatLoadError(n)):r.message&&e.handleError(e.formatRuntimerError(r.message,r.filename,r.lineno,r.colno)))},!0)},e.prototype.registerUnhandledrejectionEvent=function(){var e=this,t=this.params.error.isFilterPromiseFunc;window.addEventListener("unhandledrejection",function(r){var n=r.reason.response;if(n&&n.request){var i=n.request.ajax;i.status=r.reason.status||n.status,t&&t(i)||e.handleError({type:s.ERROR_PROMISE,desc:i})}},!0)},e.prototype.recordPage=function(){var e=this,t=this.params.record,r=t.isOpen,n=t.src;if(r){var i=document.createElement("script");i.src=n,i.onload=function(){window.rrweb&&rrweb.record({emit:function(t,r){if(r){var n=e.recordEventsMatrix.length-2;n>0&&e.recordEventsMatrix.splice(0,n),e.recordEventsMatrix.push([])}e.recordEventsMatrix[e.recordEventsMatrix.length-1].push(t)},checkoutEveryNms:2e4})},setTimeout(function(){document.head&&document.head.appendChild(i)},0)}},e.prototype.getRecentRecord=function(){var e,t=this.recordEventsMatrix.length;return e=t>=2?this.recordEventsMatrix[t-2].concat(this.recordEventsMatrix[t-1]):this.recordEventsMatrix[t-1],JSON.stringify(e)},e.prototype.handleCrashParams=function(e,t){if(e.category===s.ACTION_ERROR&&e.data.type===s.ERROR_CRASH){var r=this.getRecentRecord();r.length>0&&(t.r=r)}},e.prototype.isWhiteScreen=function(){var e=[],t=[],r=function(n){var i=n.tagName.toLowerCase(),o=n.getBoundingClientRect(),a={id:n.id,tag:i,className:n.className,display:n.style.display,height:o.height},s=n.src;s&&(a.src=s);var c=n.href;if(c&&(a.href=c),t.push(a),!(e.length>0)&&"none"!==n.style.display)return o.height>0&&"body"!==i?void e.push(n):void(n.children&&[].slice.call(n.children).forEach(function(e){var t=e.tagName.toLowerCase();"script"!==t&&"link"!==t&&r(e)}))};return r(document.body),{visibles:e,nodes:t}},e.prototype.handleError=function(e){this.params.version&&(e.version=this.params.version),this.http.send({category:s.ACTION_ERROR,data:e},this.handleCrashParams.bind(this))},e.prototype.monitorCrash=function(){var e=this,t=this.params.crash,r=t.isOpen,i=t.validateFunc;if(r){var o=function(){if(i){var t=i();t&&!t.success&&(e.handleError({type:s.ERROR_CRASH,desc:{prompt:t.prompt,url:location.href}}),clearInterval(a))}else{var r=e.isWhiteScreen();if(r.visibles.length>0)return;var o=document.querySelector("div");e.handleError({type:s.ERROR_CRASH,desc:{prompt:"页面没有高度",url:location.href,html:o?n(o.innerHTML):"",fontSize:document.documentElement.style.fontSize,nodes:r.nodes}}),clearInterval(a)}},a=setInterval(o,5e3);o(),setTimeout(function(){clearInterval(a)},3e5)}},e.prototype.formatLoadError=function(e){var t={url:e.baseURI,src:e.src||e.href};if(e.error){var r={1:"用户取消操作",2:"网络错误",3:"解码错误",4:"不支持的媒体资源格式"},n=e.error.code;n&&(t.message=r[n])}return{type:s.LOAD_ERROR_TYPE[e.nodeName.toUpperCase()],desc:t}},e.prototype.formatRuntimerError=function(e,t,r,n){var i=e.replace(/"/g,"'");return{type:s.ERROR_RUNTIME,lineno:r,colno:n,desc:{prompt:i+" at "+t+":"+r+":"+n,url:location.href}}},e.prototype.reactError=function(e,t){this.handleError({type:s.ERROR_REACT,desc:{prompt:e.toString(),url:location.href},stack:t.componentStack})},e.prototype.vueError=function(e){var t=this,r=e.config.errorHandler;e.config.errorHandler=function(e,n,i){t.handleError({type:s.ERROR_VUE,desc:{prompt:e.toString(),url:location.href},stack:e.stack}),"undefined"!=typeof console&&void 0!==console.error&&console.error(e),"function"==typeof r&&r.call(e,n,i)}},e.prototype.registerLoadEvent=function(){var e=this;window.addEventListener("load",function(){setTimeout(function(){e.monitorCrash()},1e3)})},e}(),d=function(){function e(e){this.params=e,this.http=new c(e),this.refer=location.href}return e.prototype.handleNumber=function(e){var r=typeof e;if("object"===r&&null!==e)for(var n in e){var i=Object.getOwnPropertyDescriptor(e,n);i&&i.writable&&(e[n]=this.handleNumber(e[n]))}return"number"===r?t(e,2):e},e.prototype.handleAction=function(e,t){this.http.send({category:e,data:this.handleNumber(t)})},e.prototype.injectConsole=function(){var e=this,t=this.params.console,r=t.isOpen,n=t.isFilterLogFunc;r&&["log","error"].forEach(function(t){var r=console[t];console[t]=function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];r.apply(e,i);for(var a=[],c=0,u=i;c<u.length;c++){var d=u[c];!function(e){if("[object Error]"===Object.prototype.toString.call(e)){var t={};return Object.getOwnPropertyNames(e).forEach(function(r){t[r]=e[r]}),a.push(t),"continue"}a.push(e)}(d)}var p=[],f=JSON.stringify(a,function(e,t){if("object"==typeof t&&null!==t){if(p.indexOf(t)>=0)return;p.push(t)}return t});n&&n(f)||e.handleAction(s.ACTION_PRINT,{type:t,desc:f})}})},e.prototype.sendRouterInfo=function(){var e=location.href;this.handleAction(s.ACTION_REDIRECT,{refer:this.refer,current:e}),this.refer=e},e.prototype.injectRouter=function(){var e=this,t=window.onpopstate;window.onpopstate=function(r){e.sendRouterInfo(),t&&t.apply(e,r)};var r=function(t){var r=history[t];return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var i=r.apply(history,t);return e.sendRouterInfo(),i}};history.pushState=r("pushState"),history.replaceState=r("replaceState")},e.prototype.network=function(){var e=window.navigator,t=e.connection,r=t&&t.effectiveType;if(r)return{bandwidth:0,type:r.toUpperCase()};var n="Unknown Ethernet WIFI 2G 3G 4G".split(" "),i={bandwidth:0,type:""};return t&&t.type&&(i.type=n[t.type]),i},e.prototype.handleEvent=function(e,t){var r=this;return function(i){t(i)&&r.handleAction(s.ACTION_EVENT,{type:e,desc:n(i.target.outerHTML)})}},e.prototype.injectEvent=function(){var e=this;window.addEventListener("click",this.handleEvent("click",function(t){var r=t.target;if("body"===r.nodeName.toLowerCase())return!1;var n=e.params.event.isFilterClickFunc;return!n||!n(r)}),!1)},e.prototype.injectAjax=function(){var e=this,n=this.params.ajax.isFilterSendFunc,o=window.XMLHttpRequest;window.XMLHttpRequest=function(){var e=new o;return a(e),e};var a=function(o){o.ajax={};var a,c=e;o.addEventListener("readystatechange",function(){if(4==this.readyState){var e=o.responseType;if(e&&"text"!=e&&"json"!=e)return;var u=void 0,d=void 0;try{"text"===e?(u=o.responseText,d=o.responseText):(u=JSON.stringify(o.response),d=o.response)}catch(e){u="",d={}}var p=i();o.ajax.status=o.status,o.status>=200&&o.status<300||304==o.status?o.ajax.endBytes=r(2*u.length)+"KB":o.ajax.endBytes=0;var f=void 0;if(o.getAllResponseHeaders().indexOf("req-id")>=0&&(f=o.getResponseHeader("req-id")),f&&(o.ajax.header?o.ajax.header["req-id"]=f:o.ajax.header={"req-id":f}),o.ajax.interval=t(p-a,2)+"ms",o.ajax.network=c.network(),u.length<=6e3&&(o.ajax.response=d),n&&n(o))return;c.handleAction(s.ACTION_AJAX,o.ajax)}},!1);var u=o.open;o.open=function(e,t){return o.ajax.type=e,o.ajax.url=t,u.apply(o,arguments)};var d=o.setRequestHeader;o.setRequestHeader=function(e,t){var r;return"Authorization"===e&&(o.ajax.header=(r={},r[e]=t,r)),d.apply(o,arguments)};var p=o.send;o.send=function(e){return a=i(),e&&(o.ajax.startBytes=r(2*JSON.stringify(e).length)+"KB",o.ajax.data=e),p.apply(o,arguments)}}},e}(),p=function(){return p=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},p.apply(this,arguments)},f=["SCRIPT","STYLE","META","HEAD","LINK"],l={SVG:2,IMG:2,CANVAS:4,OBJECT:4,EMBED:4,VIDEO:4},h=window.innerWidth,m=window.innerHeight,v=function(){function e(){var e=this;this.cacheTrees=[],this.callbackCount=0,this.observer=new MutationObserver(function(){var t=[];document.body&&e.doTag(document.body,e.callbackCount++,t),e.cacheTrees.push({ts:performance.now(),children:t})}),this.observer.observe(document,{childList:!0,subtree:!0})}return e.prototype.doTag=function(e,t,r){var n=e.children?e.children.length:0;if(0!==n)for(var i=e.children,o=n-1;o>=0;o--){var a=i[o],s=a.tagName;null===a.getAttribute("_ts")&&-1===f.indexOf(s)&&(a.setAttribute("_ts",t.toString()),r.push(a)),this.doTag(a,t,r)}},e.prototype.isOutScreen=function(e){var t=e.getBoundingClientRect(),r=t.left,n=t.top;return m<n||h<r},e.prototype.getFMP=function(){var e=this;this.observer.disconnect();var t={score:-1,elements:[],ts:0};return this.cacheTrees.forEach(function(r){var n=0,i=[];r.children.forEach(function(t){if(!(1!==t.nodeType||f.indexOf(t.tagName)>=0)){t.getBoundingClientRect().height>0&&!e.isOutScreen(t)&&i.push(t)}}),i=i.filter(function(t){var r=!i.some(function(e){return t!==e&&t.contains(e)});return r&&(n+=e.caculateScore(t)),r}),t.score<n&&(t.score=n,t.elements=i,t.ts=r.ts)}),this.getElementMaxTimeConsuming(t.elements,t.ts)},e.prototype.caculateScore=function(e){var t=e.getBoundingClientRect(),r=t.width,n=t.height,i=l[e.tagName]||1;return 1===i&&window.getComputedStyle(e)["background-image"]&&"initial"!==window.getComputedStyle(e)["background-image"]&&(i=l.IMG),r*n*i},e.prototype.getElementMaxTimeConsuming=function(e,t){var r=this,n={};performance.getEntries().forEach(function(e){n[e.name]=e.responseEnd});var i={ts:t,element:""};return e.forEach(function(e){var t=e.getAttribute("_ts"),o=t?r.cacheTrees[t].ts:0;switch(e.tagName){case"IMG":o=n[e.src];break;case"VIDEO":o=n[e.src],!o&&(o=n[e.poster]);break;default:var a=window.getComputedStyle(e)["background-image"].match(/url\(\"(.*?)\"\)/);if(!a)break;var s=void 0;a[1]&&(s=a[1]),s&&-1==s.indexOf("http")&&(s=location.protocol+a[1]),o=n[s]}o>i.ts&&(i.ts=o,i.element=e)}),i},e}(),g=function(){function e(e){this.params=e,this.fmpObj=new v,this.http=new c(e),this.isNeedHideEvent=!0,this.lcp={time:0,url:"",element:""},this.fmp={time:0,element:""},this.fid=0,this.beginStayTime=i()}return e.prototype.setTimingDefaultValue=function(e){0===e.redirectStart&&(e.redirectStart=e.navigationStart),0===e.redirectEnd&&(e.redirectEnd=e.navigationStart),0===e.loadEventStart&&(e.loadEventStart=e.domComplete),0===e.loadEventEnd&&(e.loadEventEnd=e.loadEventStart)},e.prototype.getTiming=function(){var e=performance.getEntriesByType("navigation")[0]||performance.timing,r=0;if(!e)return{now:r};var n;if(void 0===e.startTime){n=e.navigationStart;var o={};for(var a in e)o[a]=e[a];return this.setTimingDefaultValue(o),r=(new Date).getTime()-n,{timing:o,navigationStart:n,now:t(r)}}return n=e.startTime,r=i()-n,{timing:e,navigationStart:n,now:t(r)}},e.prototype.checkSupportPerformanceObserver=function(e){if(!window.PerformanceObserver)return!1;var t=PerformanceObserver.supportedEntryTypes;return!(!t||-1===t.indexOf(e))},e.prototype.observerLCP=function(){var e=this,r="largest-contentful-paint";if(this.checkSupportPerformanceObserver(r)){var i=new PerformanceObserver(function(r){var i=r.getEntries(),o=i[i.length-1];e.lcp={time:t(o.renderTime||o.loadTime),url:o.url,element:o.element?n(o.element.outerHTML):""}});i.observe({type:r,buffered:!0}),["keydown","click"].forEach(function(e){window.addEventListener(e,function(){i.disconnect()},{once:!0,capture:!0})})}},e.prototype.observerFID=function(){var e=this;this.checkSupportPerformanceObserver("first-input")&&new PerformanceObserver(function(r,n){var i=r.getEntries(),o=i[0];e.fid=t(o.processingStart-o.startTime),n.disconnect()}).observe({type:"first-input",buffered:!0})},e.prototype.countAllElementsOnPage=function(){for(var e=[document.documentElement],t=0,r=0,n=0;e.length;){r++;for(var i=[],o=0,a=e;o<a.length;o++){var s=a[o];t++,i.push.apply(i,Array.from(s.children)),n=Math.max(n,s.children.length)}e=i}return{maxDOMTreeDepth:r,maxChildrenCount:n,totalElementCount:t}},e.prototype.getTimes=function(){var e=this.getTiming(),r=e.timing,o=this.countAllElementsOnPage(),a=p({},o);if(!r)return null;var s=e.navigationStart;a.loadTime=r.loadEventEnd-s,a.unloadEventTime=r.unloadEventEnd-r.unloadEventStart,a.loadEventTime=r.loadEventEnd-r.loadEventStart,a.interactiveTime=r.domInteractive-s,a.domReadyTime=r.domContentLoadedEventEnd-s;var c=performance.getEntriesByType("paint");if(c&&r.entryType&&c[0]&&(a.firstPaint=c[0].startTime-r.fetchStart,a.firstPaintStart=c[0].startTime),!a.firstPaint){var u=0===r.responseEnd?this.beginStayTime:r.responseEnd;a.firstPaint=u-r.fetchStart}c&&r.entryType&&c[1]?(a.firstContentfulPaint=c[1].startTime-r.fetchStart,a.firstContentfulPaintStart=c[1].startTime):a.firstContentfulPaint=0,a.parseDomTime=r.domComplete-r.domInteractive,a.initDomTreeTime=r.domInteractive-r.responseEnd,a.readyStart=r.fetchStart-s,a.redirectCount=r.redirectCount||0,a.compression=100*(1-r.encodedBodySize/r.decodedBodySize)||0,a.redirectTime=r.redirectEnd-r.redirectStart,a.appcacheTime=r.domainLookupStart-r.fetchStart,a.lookupDomainTime=r.domainLookupEnd-r.domainLookupStart;var d=r.secureConnectionStart;a.connectSslTime=d>0?r.connectEnd-d:0,a.connectTime=r.connectEnd-r.connectStart,a.requestTime=r.responseEnd-r.requestStart,a.requestDocumentTime=r.responseStart-r.requestStart,a.responseDocumentTime=r.responseEnd-r.responseStart,a.TTFB=r.responseStart-r.redirectStart,a.now=i();for(var f in a)a[f]=t(a[f]);var l=this.fmpObj.getFMP(),h=t(l.ts-s);this.fmp={time:h>0?h:t(l.ts),element:l.element?n(l.element.outerHTML):""},a.timing={};for(var m in r){var v=r[m],g=typeof v;"function"!==g&&(a.timing[m]=v,"number"===g&&(a.timing[m]=t(v,2)))}return a.firstScreen=Math.max.call(void 0,this.fmp.time,this.lcp.time,a.domReadyTime),a.timing.lcp=this.lcp,a.timing.fmp=this.fmp,a.timing.fid=this.fid,a},e.prototype.registerLoadAndHideEvent=function(e){var r=this,n=function(){var t=r.getTimes();r.isNeedHideEvent&&t&&(r.params.record.isSendInPerformance&&e(t),r.http.sendPerformance(t),r.isNeedHideEvent=!1)},o=function(){var e={};return e.duration=t(i()-r.beginStayTime),e},a=function(){var e=o();r.http.sendBehavior(e),localStorage.removeItem(s.SHIN_BEHAVIOR_DATA)},c=function(){var e=localStorage.getItem(s.SHIN_BEHAVIOR_DATA);e&&(r.http.sendBeacon(e),localStorage.removeItem(s.SHIN_BEHAVIOR_DATA))};window.addEventListener("load",function(){c(),setTimeout(function(){n()},0),setInterval(function(){var e=o();localStorage.setItem(s.SHIN_BEHAVIOR_DATA,r.http.paramifyBehavior(e))},1e3)});var u=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),d=u?"pagehide":"beforeunload";window.addEventListener(d,function(){n(),a()},!1)},e}(),y={src:"//127.0.0.1:3000/ma.gif",psrc:"//127.0.0.1:3000/pe.gif",pkey:"",subdir:"",rate:5,version:"",author:"",record:{isOpen:!0,isSendInPerformance:!1,src:"//cdn.jsdelivr.net/npm/rrweb@latest/dist/rrweb.min.js"},error:{isFilterErrorFunc:null,isFilterPromiseFunc:null},console:{isOpen:!0,isFilterLogFunc:null},crash:{isOpen:!0,validateFunc:null},event:{isFilterClickFunc:null},ajax:{isFilterSendFunc:null},identity:{value:"",getFunc:null}},E={setParams:a};return E});
